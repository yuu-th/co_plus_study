# 相談チャット機能

> 最終更新: 2025-12-04
> ステータス: 実装完了

## 1. 概要

生徒がメンター（おにいさん・おねえさん）と1対1でチャットできる機能。LINE風の吹き出しUIで、学習相談や進路相談を行う。

### 1.1 呼称について

| システム内部 | 表示名（生徒向け） | 備考 |
|-------------|-------------------|------|
| mentor | おにいさん / おねえさん | 小中学生に親しみやすい表現 |
| student | （ユーザー名） | 生徒自身の名前を表示 |

## 2. ユーザーストーリー

- 生徒として、おにいさん・おねえさんに学習の相談をしたい。わからないことを聞きたいから。
- 生徒として、過去のやり取りを見返したい。アドバイスを確認したいから。
- 生徒として、画像を送信したい。問題の写真を見せて質問したいから。
- 生徒として、メッセージにリアクションしたい。気持ちを伝えたいから。
- メンターとして、生徒からの相談に回答したい。学習支援をしたいから。

## 3. データ構造

### Message

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | string | ✓ | 一意識別子 |
| senderId | string | ✓ | 送信者ID |
| senderName | string | ✓ | 送信者名 |
| senderRole | 'student' \| 'mentor' | ✓ | 役割 |
| type | 'text' \| 'image' | ✓ | メッセージタイプ |
| content | string | ✓ | テキスト本文（最大500文字）またはキャプション |
| imageUrl | string \| null | | 画像URL（type='image'時） |
| timestamp | ISO8601 | ✓ | 送信日時 |
| isRead | boolean | ✓ | 既読フラグ |
| reactions | MessageReaction[] | | リアクション配列 |

### MessageReaction

| フィールド | 型 | 説明 |
|-----------|-----|------|
| emoji | ReactionEmoji | 絵文字 |
| userIds | string[] | リアクションしたユーザーID配列 |

### ReactionEmoji

```typescript
type ReactionEmoji = '👍' | '❤️' | '🎉' | '👏' | '🔥';
```

※ diary.md の ReactionType と統一

### ChatRoom

| フィールド | 型 | 説明 |
|-----------|-----|------|
| id | string | チャットルームID |
| mentorId | string | メンターID |
| mentorName | string | メンター名（システム名） |
| mentorDisplayName | string | メンター表示名（例: おにいさん） |
| mentorAvatar | string \| null | メンターのアバター画像URL |
| mentorStatus | 'online' \| 'offline' | オンライン状態 |
| lastSeen | ISO8601? | 最終ログイン |
| studentId | string | 生徒ID |
| studentName | string | 生徒の表示名 |
| studentAvatar | string \| null | 生徒のアバター画像URL |
| messages | Message[] | メッセージ配列 |

## 4. コンポーネント

| 名前 | 責務 | 配置 |
|------|------|------|
| ChatHeader | メンター情報表示（アバター、表示名、オンライン状態） | features/chat/components/ |
| MessageList | メッセージ一覧（日付区切り） | features/chat/components/ |
| ChatMessage | 個別メッセージ（吹き出し、アイコン、リアクション） | features/chat/components/ |
| ChatInput | 入力エリア（テキスト、画像送信ボタン） | features/chat/components/ |
| ImagePreview | 画像プレビュー表示 | features/chat/components/ |
| ReactionPicker | リアクション絵文字選択 | features/chat/components/ |
| MessageReactions | メッセージ下のリアクション表示 | features/chat/components/ |

## 5. 画面仕様

### レイアウト
- **上部**: メンター情報ヘッダー（固定）
- **中央**: メッセージリスト（スクロール）
- **下部**: 入力エリア（固定）

### 吹き出しスタイル

#### 自分のメッセージ
- **配置**: 右寄せ
- **背景色**: `--color-message-own`
- **アバター**: 右側に配置
- **名前・日時**: メッセージ下、右揃え

#### 相手のメッセージ
- **配置**: 左寄せ
- **背景色**: `--color-message-other`
- **アバター**: 左側に配置
- **名前・日時**: メッセージ下、左揃え

### アバター表示
- サイズ: 36px × 36px
- 形状: 円形
- 未設定時: デフォルトアイコン表示

### インタラクション
- Enter送信、Shift+Enter改行
- 上スクロールで過去メッセージ読み込み
- 新着メッセージで最下部へ自動スクロール
- メッセージホバー時にリアクションボタン表示
- リアクションボタンクリックで絵文字選択パネル表示

## 6. 画像送信機能

### 仕様

| 項目 | 値 |
|------|-----|
| 対応形式 | JPEG, PNG, GIF, WebP |
| 最大サイズ | 5MB |
| 最大解像度 | 4096 × 4096 |

### UI仕様
- 入力エリア左側に画像添付ボタン（クリップアイコン）
- ファイル選択後、プレビュー表示
- プレビュー画面で「送信」「キャンセル」選択
- 送信中はプログレス表示
- 画像メッセージはサムネイル表示
- サムネイルタップで拡大表示（モーダル）

### バリデーション
- サイズ超過時: 「画像サイズは5MB以下にしてください」
- 形式エラー時: 「対応していない形式です。JPEG、PNG、GIF、WebPをお使いください」

## 7. リアクション機能

### 仕様
- 利用可能な絵文字: 👍 ❤️ 🎉 👏 🔥（diary.mdと統一）
- 同じ絵文字は1ユーザー1回まで
- 自分のリアクションはトグル可能（押す/外す）

### UI仕様
- メッセージホバー時（デスクトップ）またはロングタップ時（モバイル）にリアクションボタン表示
- リアクション選択パネル: 横並びで5種類の絵文字を表示
- リアクション済みの絵文字はハイライト表示
- メッセージ下にリアクション数を表示（例: 👍2 ❤️1）

## 8. 制約・バリデーション

| フィールド | 制約 |
|-----------|------|
| content（テキスト） | 必須、1-500文字 |
| content（画像キャプション） | 任意、0-200文字 |
| imageUrl | 5MB以下、対応形式のみ |

## 9. カラー

| 用途 | CSS変数 | 値 |
|------|---------|-----|
| 自分のメッセージ | `--color-message-own` | #DCF8C6 |
| 相手のメッセージ | `--color-message-other` | #ECECEC |
| タイムスタンプ | `--color-message-timestamp` | #999999 |
| オンライン | `--color-online` | #34B7F1 |
| オフライン | `--color-offline` | #CCCCCC |

## 10. 関連

- → specs/features/mentor.md（メンター側チャット画面）
- → specs/features/diary.md（リアクション絵文字の統一）

## 11. 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2025-12-04 | UI/UX改善: 呼称見直し、アバター・アイコン配置、画像送信機能、リアクション機能追加 |
| 2025-11-20 | 初版作成、基本実装完了 |
